{% extends 'base.html' %}

{% block content %}
  <h1>영화 상세 정보</h1>
  <span>{{ movie.title }}</span>
  <br>
  <img src="{{ movie.poster_path }}" alt="{{ movie.title }}">
  <br>
  <span>감독 : {{ movie.director }}</span>
  <br>
  <span>배우 : {{ movie.actor }}</span>
  <br>
  {% if movie.overview %}
    <span>줄거리 : {{ movie.overview }}</span>
  {% else %}
    <span>줄거리가 없습니다.</span>
  {% endif %}
  <br>
  <span>평점 : {{ movie.vote_average }}</span>
  <br>
  {% for movie_genre in movie.genres.all %}
    <span>{{ movie_genre.name }}</span>
  {% endfor %}
  <br>
  <form id="form_like" data-movieId="{{ movie.id }}" action="{% url 'movies:like' movie.id %}" method="POST" class="d-inline">
    {% csrf_token %}
    {% if user in movie.like_users.all %}
      <button class="btn btn-link">
        <i class="fas fa-heart fa-lg heart-{{ movie.id }}" style="color:crimson;"></i>
      </button>
    {% else %}
      <button class="btn btn-link">
        <i class="fas fa-heart fa-lg heart-{{ movie.id }}" style="color:black;"></i>
      </button>
    {% endif %}
  </form>

  <span id='likeCount-{{ movie.id }}'>{{ movie.like_users.all|length }}명이 이 영화를 좋아합니다.</span>
  <br>
  <video controls poster="aaa" preload="bbb">
  <source src="https://www.youtube.com/watch?v=jBdRhhSt3Bc" type="yyy">
  </video>
  <br>
  <a href="{% url 'community:index' %}">리뷰 쓰러 가기</a>
  <br>
  <h4>댓글 목록</h4>
  {% if comments|length %}
    <p><b>{{ comments|length }}개의 평점이 있습니다.</b></p>
  {% endif %}
  {% for comment in comments %}
    <div>
      {{ comment.user }}
      <br>
      {{ comment.rank }} - {{ comment.content }}
      {% if request.user == comment.user %}
        <form action="{% url 'movies:movie_comments_delete' movie.id comment.pk %}" method="POST" class="d-inline">
          {% csrf_token %}
          <input type="submit" value="DELETE">
        </form>
      {% endif %}
    </div>
  {% empty %}
    <p><b>평점이 없습니다</b></p>
  {% endfor %}
  <hr>
  {% if request.user.is_authenticated %}
    <form action="{% url 'movies:movie_comment_create' movie.id %}" method="POST">
      {% csrf_token %}
      {{ comment_form }}
      <input type="submit" value="평점쓰기">
    </form>
  {% else %}
    <a href="{% url 'accounts:login' %}">[평점을 작성하려면 로그인하세요.]</a>
  {% endif %}
  <br>
  <a href="{% url 'movies:index' %}">[back]</a>
{% endblock  %}

{% block script %}
  <script>
    const likeBtnForms = document.querySelectorAll('#form_like')
    likeBtnForms.forEach(likeBtnForm => {
      const movieId = likeBtnForm.dataset.movieid
      likeBtnForm.addEventListener('click', function (e) {
        e.preventDefault()
        // 좋아요 요청 주소 :  path('<int:review_pk>/like/', views.like, name='like'),
        const API_URL = `/movies/${movieId}/like/`
        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value
        const options = {headers: {'X-CSRFToken': csrfToken}}

        axios.post(API_URL, {}, options)
          .then(res => {
            const { is_like, like_count } = res.data
            const likeHeart = document.querySelector(`.heart-${movieId}`)
            likeHeart.style.color = is_like ? 'crimson' : 'black'
            const countHeart = document.querySelector(`#likeCount-${movieId}`)
            countHeart.innerText = `${like_count}명이 이글을 좋아합니다.`
          })
          .catch(err => {
            console.error(err)
          })

      })
    })
  </script>
{% endblock %}