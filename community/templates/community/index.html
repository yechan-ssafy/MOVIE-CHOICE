{% extends 'base.html' %}

{% block content %}
  <h1 class="text-center">Community</h1>
  {% if not user.is_authenticated %}
    <a href="{% url 'accounts:login' %}">[새 글을 작성하려면 로그인하세요]</a>
  {% else %}
    <a href="{% url 'community:create' %}">NEW</a>
  {% endif %}
  <hr>
  {% for review in users %}
    <p><b>작성자 : <a href="{% url 'accounts:profile' review.user.username %}">{{ review.user }}</a></b></p>
    <p>글 번호: {{ review.pk }}</p>
    <p>영화 제목: {{ review.movie.title }}</p>
    <p>글 제목: {{ review.title }}</p>
    <p>글 내용: {{ review.content }}</p>
    <form id="form_like" data-reviewId="{{ review.pk }}"action="{% url 'community:like' review.pk %}" method="POST" class="d-inline">
      {% csrf_token %}
      {% if user in review.like_users.all %}
        <button class="btn btn-link">
          <i class="fas fa-heart fa-lg heart-{{ review.pk }}" style="color:crimson;"></i>
        </button>
      {% else %}
        <button class="btn btn-link">
          <i class="fas fa-heart fa-lg heart-{{ review.pk }}" style="color:black;"></i>
        </button>
      {% endif %}
    </form>

    <span id='likeCount-{{ review.pk }}'>{{ review.like_users.all|length }}명이 이 글을 좋아합니다.</span> <br>
    <a href="{% url 'community:detail' review.pk %}">[detail]</a>
    <hr>
  {% endfor %}

  <!-- pagination -->
  {% if users.has_other_pages %}
    <ul class="pagination">
      {% if users.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ users.previous_page_number }}">&laquo;</a></li>
      {% endif %}

      {% if users.number > 4 %}
        <li class="page-item"><a class="page-link" href="?page={{ 1 }}">1</a></li>
        <li class="page-item"><span class="page-link">...<span class="sr-only">...</span></span></li>
      {% endif %}

      {% for i in page_range %}
        {% if users.number == i %}
          <li class="page-item active"><span class="page-link">{{ i }}<span class="sr-only">(current)</span></span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
        {% endif %}
      {% endfor %}

      {% if users.number < prev_max_index %}
        <li class="page-item"><span class="page-link">...<span class="sr-only">...</span></span></li>
        <li class="page-item"><a class="page-link" href="?page={{ max_index|add:"1" }}">{{ max_index|add:"1" }}</a></li>
      {% endif %}

      {% if users.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ users.next_page_number }}">&raquo;</a></li>
      {% endif %}
    </ul>
  {% endif %}
{% endblock %}

{% block script %}
<script>
  const likeBtnForms = document.querySelectorAll('#form_like')
  likeBtnForms.forEach(likeBtnForm => {
    const reviewId = likeBtnForm.dataset.reviewid
    likeBtnForm.addEventListener('click', function (e) {
      e.preventDefault()
      // 좋아요 요청 주소 :  path('<int:review_pk>/like/', views.like, name='like'),
      const API_URL = `/community/${reviewId}/like/`
      const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value
      const options = {headers: {'X-CSRFToken': csrfToken}}

      axios.post(API_URL, {}, options)
        .then(res => {
          const { is_like, like_count } = res.data
          const likeHeart = document.querySelector(`.heart-${reviewId}`)
          likeHeart.style.color = is_like ? 'crimson' : 'black'
          const countHeart = document.querySelector(`#likeCount-${reviewId}`)
          countHeart.innerText = `${like_count}명이 이글을 좋아합니다.`
        })
        .catch(err => {
          console.error(err)
        })

    })
  })

</script>
{% endblock %}
